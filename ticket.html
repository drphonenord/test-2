<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fiche ticket — Dr Phone</title>
  <meta name="description" content="Fiche de suivi à remettre au client avec code et QR.">
  <style>
    :root{--fg:#0b1220;--muted:#6b7280;--border:#e5e7eb}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--fg);background:#fff}
    .wrap{max-width:820px;margin:0 auto;padding:20px}
    .card{border:1px solid var(--border);border-radius:16px;padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    h1{margin:0;font-size:24px}
    .muted{color:var(--muted)}
    .code{font-size:28px;font-weight:800;letter-spacing:1px}
    .qr{width:180px;height:180px;border:1px solid var(--border);border-radius:8px}
    .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .btn{display:inline-block;border:1px solid #111;background:#111;color:#fff;padding:8px 12px;border-radius:10px;text-decoration:none}
    @media print {.btn{display:none} .card{border:none} .wrap{padding-top:0}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Fiche suivi — Dr Phone</h1>
        <div class="muted">À présenter pour suivre ou récupérer l’appareil</div>
      </div>
      <a class="btn" href="#" onclick="window.print();return false;">Imprimer</a>
    </div>
    <div class="card">
      <div class="row">
        <div>
          <div class="muted">Code</div>
          <div class="code" id="code">—</div>
          <div class="muted" style="margin-top:8px">Lien direct</div>
          <div><a id="link" href="#" target="_blank">—</a></div>
          <div class="muted" style="margin-top:8px">Statut</div>
          <div id="status">—</div>
        </div>
        <div style="text-align:center">
          <img id="qr" class="qr" alt="QR suivi" />
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <div>
          <div class="muted">Modèle</div>
          <div id="model">—</div>
        </div>
        <div>
          <div class="muted">Client</div>
          <div id="client">—</div>
        </div>
      </div>
      <div style="margin-top:12px">
        <div class="muted">Note</div>
        <div id="note">—</div>
      </div>
      <div class="muted" style="margin-top:12px;font-size:.9rem">Adresse suivi : <span id="host"></span></div>
    </div>
  </div>
  <script>
    const FN='/.netlify/functions/tickets';
    const params = new URLSearchParams(location.search);
    const code = params.get('code')||'';
    const host = location.origin;
    document.getElementById('host').textContent = host + '/suivi.html';
    async function load(){
      if(!code){ document.getElementById('code').textContent='—'; return; }
      const r = await fetch(FN+'?id='+encodeURIComponent(code));
      const j = await r.json().catch(()=>null);
      if(!r.ok || !j){ document.getElementById('code').textContent=code; return; }
      document.getElementById('code').textContent = j.code||code;
      const link = host + '/suivi.html#' + encodeURIComponent(j.code||code);
      const el = document.getElementById('link'); el.href = link; el.textContent = link;
      document.getElementById('status').textContent = j.status||'—';
      document.getElementById('model').textContent = j.model||'—';
      document.getElementById('client').textContent = j.client||'—';
      document.getElementById('note').textContent = j.note||'—';
      // QR code via public API (léger). Option: on peut embarquer une lib QR plus tard si tu veux offline.
      document.getElementById('qr').src = 'https://api.qrserver.com/v1/create-qr-code/?size=180x180&margin=0&data=' + encodeURIComponent(link);
    }
    load();
  </script>
</body>
</html>
