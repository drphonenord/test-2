<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<title>Admin — Prix Reprise</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
body{font-family:system-ui;max-width:900px;margin:24px auto;padding:0 16px}
fieldset{border:1px solid #ddd;padding:16px;margin-bottom:16px}
label{display:block;margin:6px 0 2px}
input,select{width:100%;padding:8px}
table{width:100%;border-collapse:collapse;margin-top:16px}
th,td{border:1px solid #eee;padding:8px;text-align:left;font-size:14px}
.ok{color:green} .err{color:#c33}
</style>
</head>
<body>
<h1>Admin — Tarifs de reprise</h1>
<fieldset>
<legend>Clé admin</legend>
<input id="token" placeholder="Colle la valeur de ADMIN_TOKEN"/>
<button onclick="saveToken()">Enregistrer le token</button>
</fieldset>

<fieldset>
<legend>Ajouter / Mettre à jour un tarif</legend>
<label>Marque</label><input id="brand" placeholder="Apple"/>
<label>Modèle</label><input id="model" placeholder="iPhone 13"/>
<label>Stockage (Go)</label><input id="storage" type="number" placeholder="128"/>
<label>Min (€)</label><input id="min" type="number" placeholder="180"/>
<label>Max (€)</label><input id="max" type="number" placeholder="260"/>
<button onclick="savePrice()">Enregistrer</button>
<p id="status"></p>
</fieldset>

<h2>Tarifs actuels</h2>
<table id="tbl"><thead><tr>
<th>Marque</th><th>Modèle</th><th>Stockage</th><th>Min</th><th>Max</th><th>Médiane</th>
</tr></thead><tbody></tbody></table>

<script>
const FN = "/.netlify/functions/prices";

function saveToken(){
  localStorage.setItem("drp_token", document.getElementById("token").value.trim());
  alert("Token enregistré !");
}

async function load(){
  const r = await fetch(FN);
  const data = await r.json();
  render(data);
}

function render(data){
  const tb = document.querySelector("#tbl tbody");
  tb.innerHTML = "";
  for (const brand of Object.keys(data).sort()){
    for (const model of Object.keys(data[brand]).sort()){
      for (const storage of Object.keys(data[brand][model]).sort((a,b)=>+a-+b)){
        const {min,max} = data[brand][model][storage];
        const med = Math.round((Number(min)+Number(max))/2);
        tb.insertAdjacentHTML("beforeend",
          `<tr><td>${brand}</td><td>${model}</td><td>${storage}</td><td>${min}</td><td>${max}</td><td>${med}</td></tr>`);
      }
    }
  }
}

async function savePrice(){
  const brand = document.getElementById("brand").value.trim();
  const model = document.getElementById("model").value.trim();
  const storage = document.getElementById("storage").value.trim();
  const min = Number(document.getElementById("min").value);
  const max = Number(document.getElementById("max").value);
  const status = document.getElementById("status");
  status.textContent = "";

  if(!brand || !model || !storage || !min || !max){
    status.textContent = "Champs manquants."; status.className="err"; return;
  }

  const token = localStorage.getItem("drp_token") || document.getElementById("token").value.trim();
  if(!token){ alert("Renseigne ton ADMIN_TOKEN"); return; }

  const payload = { [brand]: { [model]: { [storage]: { min, max } } } };

  try{
    const r = await fetch(FN, {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "x-admin-token": token
      },
      body: JSON.stringify(payload)
    });
    const j = await r.json();
    if(!r.ok){ throw new Error(j.error || "POST failed"); }
    status.textContent = "Sauvegardé.";
    status.className = "ok";
    await load();
  }catch(e){
    status.textContent = e.message;
    status.className = "err";
  }
}

load();
</script>
</body>
</html>
